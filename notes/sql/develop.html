<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>进阶 | 记录人生学习档案</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="📝记录人生学习档案">
    
    <link rel="preload" href="/notes/assets/css/0.styles.501a61ce.css" as="style"><link rel="preload" href="/notes/assets/js/app.74070628.js" as="script"><link rel="preload" href="/notes/assets/js/7.8c1b57da.js" as="script"><link rel="preload" href="/notes/assets/js/2.08219823.js" as="script"><link rel="preload" href="/notes/assets/js/1.03a74d01.js" as="script"><link rel="preload" href="/notes/assets/js/45.648d69eb.js" as="script"><link rel="prefetch" href="/notes/assets/js/10.c1ecd427.js"><link rel="prefetch" href="/notes/assets/js/11.0f2b057c.js"><link rel="prefetch" href="/notes/assets/js/14.387f9987.js"><link rel="prefetch" href="/notes/assets/js/15.c84fcb66.js"><link rel="prefetch" href="/notes/assets/js/16.ac6caa6f.js"><link rel="prefetch" href="/notes/assets/js/17.bbea281b.js"><link rel="prefetch" href="/notes/assets/js/18.591585f4.js"><link rel="prefetch" href="/notes/assets/js/19.8e045775.js"><link rel="prefetch" href="/notes/assets/js/20.569c6fea.js"><link rel="prefetch" href="/notes/assets/js/21.5284221e.js"><link rel="prefetch" href="/notes/assets/js/22.f29fe248.js"><link rel="prefetch" href="/notes/assets/js/23.141e596a.js"><link rel="prefetch" href="/notes/assets/js/24.a6127588.js"><link rel="prefetch" href="/notes/assets/js/25.25f9fdd2.js"><link rel="prefetch" href="/notes/assets/js/26.1f6f2ab7.js"><link rel="prefetch" href="/notes/assets/js/27.4e6087a2.js"><link rel="prefetch" href="/notes/assets/js/28.8a49b2e2.js"><link rel="prefetch" href="/notes/assets/js/29.f25e07e2.js"><link rel="prefetch" href="/notes/assets/js/3.c12034c9.js"><link rel="prefetch" href="/notes/assets/js/30.c1ec336c.js"><link rel="prefetch" href="/notes/assets/js/31.c7054ff0.js"><link rel="prefetch" href="/notes/assets/js/32.00625d31.js"><link rel="prefetch" href="/notes/assets/js/33.ac3e0dfc.js"><link rel="prefetch" href="/notes/assets/js/34.28a3c746.js"><link rel="prefetch" href="/notes/assets/js/35.e33c6d0c.js"><link rel="prefetch" href="/notes/assets/js/36.003c3aba.js"><link rel="prefetch" href="/notes/assets/js/37.80bbeb03.js"><link rel="prefetch" href="/notes/assets/js/38.a8170c0e.js"><link rel="prefetch" href="/notes/assets/js/39.0c8536a0.js"><link rel="prefetch" href="/notes/assets/js/4.86f1ffa0.js"><link rel="prefetch" href="/notes/assets/js/40.efc57ffe.js"><link rel="prefetch" href="/notes/assets/js/41.4625c353.js"><link rel="prefetch" href="/notes/assets/js/42.8f2da1ff.js"><link rel="prefetch" href="/notes/assets/js/43.03859945.js"><link rel="prefetch" href="/notes/assets/js/44.5a9dc470.js"><link rel="prefetch" href="/notes/assets/js/46.55516868.js"><link rel="prefetch" href="/notes/assets/js/47.25c1936f.js"><link rel="prefetch" href="/notes/assets/js/48.4cb7764e.js"><link rel="prefetch" href="/notes/assets/js/5.a5a3f1b1.js"><link rel="prefetch" href="/notes/assets/js/6.57a93823.js"><link rel="prefetch" href="/notes/assets/js/8.49f1c9c9.js"><link rel="prefetch" href="/notes/assets/js/9.a2cd17ce.js"><link rel="prefetch" href="/notes/assets/js/vendors~docsearch.fc71871b.js">
    <link rel="stylesheet" href="/notes/assets/css/0.styles.501a61ce.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>记录人生学习档案</h3> <p class="description" data-v-59e6cb88>📝记录人生学习档案</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2025
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/notes/" class="home-link router-link-active"><!----> <span class="site-name">记录人生学习档案</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/notes/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      nora的超链接
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/xtt" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><!----> <!----> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>6</h3> <h6 data-v-1fad0c41>文章</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>0</h3> <h6 data-v-1fad0c41>标签</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/notes/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      nora的超链接
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/xtt" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/notes/" class="sidebar-heading clickable router-link-active open"><span>欢迎学习</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes/" aria-current="page" class="sidebar-link">参观前必读</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/notes/notes/computerNetwork" class="sidebar-heading clickable"><span>基础学习</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes/notes/hc.html" class="sidebar-link">Html/Css</a></li><li><a href="/notes/notes/computerNetwork.html" class="sidebar-link">计算机网络</a></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/notes/notes/vue/basic" class="sidebar-heading clickable"><span>vue知识点</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes/notes/vue/basic.html" class="sidebar-link">基础理念</a></li><li><a href="/notes/notes/vue/develop.html" class="sidebar-link">基础开发</a></li><li><a href="/notes/notes/vue/component.html" class="sidebar-link">深入组件</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/notes/notes/react/basic" class="sidebar-heading clickable"><span>react知识点</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/notes/notes/sql/basic" class="sidebar-heading clickable open"><span>mysql</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes/notes/sql/basic.html" class="sidebar-link">基础理念</a></li><li><a href="/notes/notes/sql/develop.html" aria-current="page" class="active sidebar-link">进阶</a></li></ul></section></li><li><a href="/notes/notes/review.html" class="sidebar-link">面试集合点</a></li><li><a href="/notes/notes/answer.html" class="sidebar-link">面试点解析</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>进阶</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2025
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">进阶</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>nora</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>2024/5/10</span></i> <!----> <!----></div></div> <div class="theme-reco-content content__default"><h1 id="进阶"><a href="#进阶" class="header-anchor">#</a> 进阶</h1> <h2 id="mysql体系结构"><a href="#mysql体系结构" class="header-anchor">#</a> MySQL体系结构</h2> <p><img src="/notes/assets/img/sql.d2f84921.png" alt="这是图片" title="Magic Gardens"></p> <p>我们可以看到MySQL Server是分层的，<strong>分为连接层、服务层、引擎层和存储层</strong></p> <ul><li>连接层：主要接收客户端的连接，完成连接的处理并且完成连接的授权</li> <li>服务层：绝大部分的功能是在服务层实现的，如sql接口、解析器等</li> <li>引擎层：存储引擎的提供</li> <li>存储层：存储数据库的相关数据</li></ul> <h2 id="存储引擎"><a href="#存储引擎" class="header-anchor">#</a> <strong>存储引擎</strong></h2> <h3 id="简介"><a href="#简介" class="header-anchor">#</a> 简介</h3> <blockquote><p>存储引擎就是存储数据、建立索引、更新/查询数据等技术的实现方式。存储引擎是基于表的，而不是基于库的，所以存储引擎也可以被称为表类型。<strong>MySQL建表的默认存储引擎为InnoDB</strong>。</p></blockquote> <ul><li>在创建表时，可以指定存储引擎</li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> 表名<span class="token punctuation">(</span>
	字段<span class="token number">1</span> 字段<span class="token number">1</span>类型 <span class="token punctuation">[</span><span class="token keyword">COMMENT</span> 字段<span class="token number">1</span>注释<span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	字段n 字段n类型 <span class="token punctuation">[</span><span class="token keyword">COMMENT</span> 字段n注释<span class="token punctuation">]</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token punctuation">[</span><span class="token keyword">COMMENT</span> 表注释<span class="token punctuation">]</span><span class="token punctuation">;</span>

</code></pre></div><ul><li>查看当前数据库支持的存储引擎</li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SHOW</span> ENGINES<span class="token punctuation">;</span>
</code></pre></div><h3 id="特点"><a href="#特点" class="header-anchor">#</a> 特点</h3> <ul><li>InnoDB：InnoDB是一种兼顾高可靠性和高性能的通用存储引擎。innoDB引擎的每张表都会对应这样一个表空间文件xxx.ibd，存储该表的表结构、数据和索引。其特点是
<ul><li>DML操作遵循ACID模型，支持事务</li> <li>行级锁，提高并发访问性能</li> <li>支持外键FOREIGN KEY约束，保证数据的完整性和正确性</li></ul></li> <li>MyISAM：MyISAM是MySQL早期的默认存储引擎。其特点是：
<ul><li>不支持事务，不支持外键</li> <li>支持表锁，不支持行锁</li> <li>访问速度快</li></ul></li> <li>Memory：Memory引擎的表数据是存储在内存中的，由于受到硬件问题的影响，只能将这些表作为临时表或缓存使用。其特点是:
<ul><li>内存存放</li> <li>hash索引（默认）</li></ul></li></ul> <h2 id="索引"><a href="#索引" class="header-anchor">#</a> 索引</h2> <h3 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h3> <blockquote><p>索引(index)是帮助MySQL高效获取数据的数据结构。在数据之外，数据库系统还维护着满足特定查找算法的数据结构，这些数据结构以某种方式引用数据，这样就可以在这些数据结构上实现高效查找算法。</p></blockquote> <ul><li><strong>优点！</strong> <ul><li>提高数据检索的效率，降低数据库的IO成本</li> <li>通过索引列对数据进行排序，降低数据排序的成本，降低CPU的消耗</li></ul></li> <li><strong>缺点！！！</strong> <ul><li>索引列也是需要占一定空间的</li> <li>索引大大提高了查询效率，同时却也降低更新表的速度，如对表进行INSERT、UPDATE、DELETE时，效率降低</li></ul></li></ul> <h3 id="结构"><a href="#结构" class="header-anchor">#</a> 结构</h3> <p>MySQL的索引是在存储引擎层实现的，不同的存储引擎有不同的结构。</p> <table><thead><tr><th>索引结构</th> <th>描述</th></tr></thead> <tbody><tr><td>B+Tree索引</td> <td>最常见的索引类型，大部分引擎支持B+树索引</td></tr> <tr><td>Hash索引</td> <td>底层数据结构是用哈希表实现的，只有精确匹配索引列的查询才有效，不支持范围查询</td></tr> <tr><td>R tree（空间索引）</td> <td>空间索引是MyISAM引擎的一个特殊索引类型，主要用于地理空间数据类型，通常是用较少</td></tr> <tr><td>Full-text（全文索引）</td> <td>是一种通过建立倒排索引，快速匹配文档的方式。</td></tr></tbody></table> <p>其中以上各种索引结构在各存储引擎的支持情况如下</p> <table><thead><tr><th>索引</th> <th>InnoDB</th> <th>MyISAM</th> <th>Memory</th></tr></thead> <tbody><tr><td>B+Tree索引</td> <td>支持</td> <td>支持</td> <td>支持</td></tr> <tr><td>Hash索引</td> <td>不支持</td> <td>不支持</td> <td>支持</td></tr> <tr><td>R tree（空间索引）</td> <td>不支持</td> <td>支持</td> <td>不支持</td></tr> <tr><td>Full-text（全文索引）</td> <td>5.6版本后支持</td> <td>支持</td> <td>不支持</td></tr></tbody></table> <h3 id="索引分类"><a href="#索引分类" class="header-anchor">#</a> <strong>索引分类</strong></h3> <p>索引分类主要分为以下四类</p> <table><thead><tr><th>分类</th> <th>含义</th> <th>特点</th> <th>关键字</th></tr></thead> <tbody><tr><td>主键索引</td> <td>针对表中主键创建的索引</td> <td>默认自动创建，只能有一个</td> <td>PRIMARY</td></tr> <tr><td>唯一索引</td> <td>避免同一个表中某数据列中的值重复</td> <td>可以有多个</td> <td>UNIQUE</td></tr> <tr><td>常规索引</td> <td>快速定位特定数据</td> <td>可以有多个</td> <td></td></tr> <tr><td>全文索引</td> <td>全文索引查找的是文本中的关键词，而不是比较索引中的值</td> <td>可以有多个</td> <td>FULLTEXT</td></tr></tbody></table> <p>在InnoDB存储引擎中，根据索引的存储引擎，又可以分为以下两种</p> <table><thead><tr><th>分类</th> <th>含义</th> <th>特点</th></tr></thead> <tbody><tr><td>聚焦索引（Clustered Index）</td> <td>将数据存储与索引放到了一块，索引结构的叶子节点保存了行数据</td> <td>必须有，而且只有一个</td></tr> <tr><td>二级索引（Secondary Index）</td> <td>将数据与索引分开存储，索引结构的叶子节点关联的是对应的主键</td> <td>可以存在多个</td></tr></tbody></table> <p>聚集索引选取规则</p> <ul><li>如果存在主键，主键索引就是聚集索引</li> <li>如果不存在主键，将使用第一个唯一索引作为聚集索引</li> <li>如果表没有主键，或没有合适的唯一索引，则InnoDB将会自动生成一个rowid作为隐藏的聚集索引</li></ul> <p>一般是先在二级索引上找到主键数据，再回表查询在聚集索引上找到行数据</p> <h3 id="索引语法"><a href="#索引语法" class="header-anchor">#</a> <strong>索引语法</strong></h3> <p>创建索引</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token punctuation">[</span><span class="token keyword">UNIQUE</span><span class="token operator">|</span>FULLTEXT<span class="token punctuation">]</span> <span class="token keyword">INDEX</span> index_name <span class="token keyword">ON</span> table_name <span class="token punctuation">(</span>index_col_name<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
</code></pre></div><p>查看索引</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SHOW</span> <span class="token keyword">INDEX</span> <span class="token keyword">FROM</span> table_name
</code></pre></div><p>删除索引</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> index_name <span class="token keyword">ON</span> table_name
</code></pre></div><h3 id="sql性能分析"><a href="#sql性能分析" class="header-anchor">#</a> <strong>SQL性能分析</strong></h3> <ul><li>SQL执行频率</li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">show</span> <span class="token keyword">global</span> <span class="token keyword">status</span> <span class="token operator">like</span> <span class="token string">'Com_______'</span><span class="token punctuation">;</span>

得到结果

</code></pre></div><p><img src="%E8%BF%9B%E9%98%B6%20e6f38e99be724120a1e2138efebeb25f/Untitled%201.png" alt="Untitled"></p> <p>可以看到我们现在当前数据库以上各种操作的次数，我们就可以看当前数据库哪种操作为主</p> <ul><li>慢查询日志：慢查询日志记录了所有执行时间超过指定参数（long_query_time，单位：秒，默认10s）的所有sql语句的日志。</li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'slow_query_log'</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>profile详情：show profiles能够在做MySQL优化时帮助我们了解时间都耗费到哪里去了，通过having_profiling参数，能够看到当前MySQL是否支持profile操作</li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> @<span class="token variable">@have_profiling</span><span class="token punctuation">;</span>
</code></pre></div><p>默认是关闭的，可以通过set语句在session/global级别开启profiling</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SET</span> profiling<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
</code></pre></div><p>执行一系列的业务SQL操作，可以通过以下直领查看执行耗时情况</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">show</span> profiles<span class="token punctuation">;</span>
</code></pre></div><ul><li>explain执行计划</li></ul> <p>explain 或者 desc命令获取MySQL如何执行select语句的信息，包括在select语句执行过程中表如何连接和连接的顺序</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tb_sku <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token operator">*</span>   id：<span class="token keyword">select</span> 查询的序列号，表示查询中执行<span class="token keyword">select</span>子句或者是操作表的顺序（id相同，执行顺序从上到下；id不同，id值越大，越先执行）
<span class="token operator">*</span>   <span class="token keyword">select</span>\_type：表示<span class="token keyword">select</span> 的类型，常见的取值有<span class="token keyword">SIMPLE</span>（简单表，即不使用表连接或子查询），<span class="token keyword">PRIMARY</span>（主查询，即外层的查询），<span class="token keyword">UNION</span>（<span class="token keyword">UNION</span>中的第二个或者后面的查询语句），SUBQUERY（<span class="token keyword">SELECT</span><span class="token operator">/</span><span class="token keyword">WHERE</span> 后面包含了子查询）等
<span class="token operator">*</span>   <span class="token keyword">type</span>：表示连接类型，性能由好到差的连接类型为<span class="token boolean">NULL</span>、system、const、eq\_ref、ref、range、<span class="token keyword">index</span>、<span class="token keyword">all</span>
<span class="token operator">*</span>   possible\_key：显示可能应用在这张表上的索引，一个或多个
<span class="token operator">*</span>   <span class="token keyword">key</span>：实际使用的索引，如果为<span class="token boolean">NULL</span>，则没有使用索引
<span class="token operator">*</span>   <span class="token keyword">key</span>\_len：表示索引中使用的字节数，该值为索引字段最大可能长度，并非实际使用长度，在不损失精确性的前提下，长度越短越好
<span class="token operator">*</span>   <span class="token keyword">rows</span>：MySQL认为必须要执行查询的行数，在<span class="token keyword">InnoDB</span>引擎的表中，是一个估计值，可能并不总是准确的
<span class="token operator">*</span>   filtered：表示返回结果的行数占需要读取行数的百分比，filtered的值越大越好
</code></pre></div><h3 id="索引使用规则"><a href="#索引使用规则" class="header-anchor">#</a> <strong>索引使用规则</strong></h3> <ul><li>最左前缀法则：如果索引了多列（联合索引），要遵守最左前缀法则。最左前缀法则指的是查询从索引的最左列开始，并且不跳过索引中的列。如果跳跃某一列，索引将部分失效（后面的字段索引失效）。</li> <li>范围查询：联合索引中，出现范围查询（&gt;、&lt;），范围查询右侧的列索引失效</li> <li>索引失效情况：
<ul><li>在索引列上进行运算操作</li> <li>字符串类型字段查询不加引号</li> <li>如果仅仅是尾部模糊匹配，索引不会失效，如果是头部模糊匹配，索引失效</li> <li>用or分割开的条件，如果or前的条件的列有索引，而后面的列中没有索引，那么涉及的索引都不会被用到</li> <li>如果MySQL评估使用索引比全表更慢，则不会使用索引</li></ul></li> <li>覆盖索引和回表查询：尽量使用覆盖索引（查询使用了索引，并且需要返回的列，在该索引中已经全部能够找到），减少select *。会有以下两种情况
<ul><li>using index condition：查找使用了索引，但是需要回表查询数据</li> <li>using where; using index：查找使用了索引，但是需要的数据都在索引列中能找到，所以不需要回表查询数据</li></ul></li> <li>前缀索引：当字段类型为字符串时，有时候需要索引很长的字符串，这会让索引变得很大，查询时，浪费大量的磁盘IO，影响查询效率。此时可以只将字符串的一部分前缀建立索引，这样可以大大节约索引空间，从而提高索引效率。</li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">index</span> idx <span class="token keyword">on</span> table_name<span class="token punctuation">(</span><span class="token keyword">column</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>前缀长度可以根据索引的选择性来决定，而选择性是指不重复的索引值和数据表的记录总数的比值，索引选择性越高则查询效率越高，唯一索引的选择性为1，这是性能最好的索引选择性</p> <ul><li>单列及联合索引
<ul><li>单列索引：即一个索引只包含单个列</li> <li>联合索引：即一个索引包含多个列</li></ul></li></ul> <h3 id="索引设计原则"><a href="#索引设计原则" class="header-anchor">#</a> <strong>索引设计原则</strong></h3> <ul><li>针对于数据量较大，且查询比较频繁的表建立索引</li> <li>针对于常作为查询条件、排序、分组操作的字段建立索引</li> <li>尽量选择区分度高的列作为索引，尽量建立唯一索引，区分度越高，使用索引的效率越高</li> <li>如果是字符串类型的字段，字段的长度较长，可以针对于字段的特点，建立前缀索引</li> <li>尽量使用联合索引，减少单列索引，查询时，联合索引很多时候可以覆盖索引，节省存储空间，避免回表，提高查询效率</li> <li>如果索引列不能存储NULL值，请在创建表时使用NOT NULL约束它，当优化器知道每列是否包含NULL值时，它可以更好地确定哪个索引最有效地用于查询</li> <li>要控制索引的数量，索引并不是多多益善，索引越多，维护索引的代价也就越大，会影响增删改的效率</li></ul> <h2 id="sql优化"><a href="#sql优化" class="header-anchor">#</a> <strong>SQL优化</strong></h2> <h3 id="插入数据优化"><a href="#插入数据优化" class="header-anchor">#</a> 插入数据优化</h3> <ul><li>批量插入，避免每一次插入数据与数据库进行连接</li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> tb_test <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'Tom'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'Cat'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'jerry'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>手动提交事务</li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">start</span> <span class="token keyword">transaction</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> tb_test <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'Tom'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'Cat'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'jerry'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> tb_test <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">'Tom'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string">'Cat'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token string">'jerry'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> tb_test <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token string">'Tom'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'Cat'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token string">'jerry'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>主键顺序插入</li> <li>大批量插入数据：如果需要一次性插入大批量数据，使用insert语句插入性能较低，此时可以使用MySQL数据库提供的load指令进行插入</li></ul> <h3 id="主键优化"><a href="#主键优化" class="header-anchor">#</a> 主键优化</h3> <ul><li>数据组织方式：在InnoDB存储引擎中，表数据都是根据主键顺序组织存放的，这种存储方式的表称为索引组织表</li></ul> <p><img src="%E8%BF%9B%E9%98%B6%20e6f38e99be724120a1e2138efebeb25f/Untitled%202.png" alt="Untitled"></p> <ul><li>页分裂：页可以为空，也可以填充一半。每个页包含了2-N行数据，根据主键排列。当主键乱序插入时，一页可能按照原本顺序无法插入数据，因此可能会产生页分裂的情况来按照主键顺序排列</li> <li>页合并：当删除一行记录时，实际上记录并没有被物理删除，只是记录被标记为删除并且它的空间变得允许被其他记录声明使用。一旦被标记删除后，当页中删除的记录达到MERGE_THRESHOLD，InnoDB会开始寻找最靠近的页，看看是否可以将两个页合并以优化空间使用。</li> <li>主键设计原则
<ul><li>在满足业务需求的情况下，尽量降低主键的长度。</li> <li>插入数据时，尽量选择顺序插入，选择使用AUTO_INCREMENT自增主键</li> <li>尽量不要使用UUID做主键或者是其他自然主键，如身份证号</li> <li>业务操作时，避免对主键的修改</li></ul></li></ul> <h3 id="order-by优化"><a href="#order-by优化" class="header-anchor">#</a> order by优化</h3> <ul><li>两种形式
<ul><li>Using filesort：通过表的索引或全表扫描，读取满足条件的数据行，然后在排序缓冲区中完成排序操作，所有不是通过索引直接返回排序结果的排序都叫FileSort排序</li> <li>Using index：通过有序索引顺序扫描直接返回有序数据，这种情况即为using index，不需要额外排序，操作效率高</li></ul></li> <li>根据排序字段建立合适的索引，多字段排序时，也遵循最左前缀法则</li> <li>尽量使用覆盖索引</li> <li>多字段排序，一个升序一个降序，此时需注意联合索引在创建时的规则</li> <li>如果不可避免出现filesort，大数据量排序时，可以适当增大排序缓冲区大</li></ul> <h3 id="group-by优化"><a href="#group-by优化" class="header-anchor">#</a> group by优化</h3> <ul><li>在分组操作时，可以通过索引来提高效率</li> <li>分组操作时，索引的使用也是满足最左前缀法则的</li></ul> <h3 id="limit优化"><a href="#limit优化" class="header-anchor">#</a> limit优化</h3> <ul><li>覆盖索引+子查询：一般分页查询时，通过创建覆盖索引能够比较好地提高性能，可以通过覆盖索引加子查询形式进行优化</li></ul> <h2 id="视图-存储过程-触发器"><a href="#视图-存储过程-触发器" class="header-anchor">#</a> <strong>视图-存储过程-触发器</strong></h2> <h3 id="视图"><a href="#视图" class="header-anchor">#</a> 视图</h3> <ul><li><p>介绍：视图（View）是一种虚拟存在的表。视图中的数据并不在数据库中实际存在，行和列数据来自定义视图的查询中使用的表，并且是在使用视图时动态生成的</p></li> <li><p>创建</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- 创建视图</span>
<span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">view</span> stu_v_1 <span class="token keyword">as</span> <span class="token keyword">select</span> id<span class="token punctuation">,</span> name <span class="token keyword">from</span> student <span class="token keyword">where</span> id <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>查询视图</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- 查询视图</span>
<span class="token keyword">show</span> <span class="token keyword">create</span> <span class="token keyword">view</span> stu_v_1<span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> stu_v_1<span class="token punctuation">;</span>
</code></pre></div></li> <li><p>修改视图</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- 修改视图</span>
<span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">view</span> stu_v_1 <span class="token keyword">as</span> <span class="token keyword">select</span> id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token keyword">no</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> id <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword">alter</span> <span class="token keyword">view</span> test<span class="token punctuation">.</span>stu_v_1 <span class="token keyword">as</span> <span class="token keyword">select</span> id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token keyword">no</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> id <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">;</span>

</code></pre></div></li> <li><p>删除视图</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">drop</span> <span class="token keyword">view</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> stu_v_1<span class="token punctuation">;</span>
</code></pre></div></li></ul> <aside>
⚠️ **检查选项：当使用with check option子句创建视图时，MySQL会通过视图检查正在更改的每个行，以使其符合视图的定义。**
</aside> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">view</span> stu_v_1 <span class="token keyword">as</span> <span class="token keyword">select</span> id<span class="token punctuation">,</span> name <span class="token keyword">from</span> student <span class="token keyword">where</span> id <span class="token operator">&lt;=</span> <span class="token number">10</span> <span class="token keyword">with</span> <span class="token keyword">cascaded</span> <span class="token keyword">check</span> <span class="token keyword">option</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="存储过程"><a href="#存储过程" class="header-anchor">#</a> <strong>存储过程</strong></h3> <ul><li><p>介绍：存储过程是事先经过编译并存储在数据库中的一段SQL语句的集合。存储过程可以对SQL语句进行封装和复用，类似于编程语言中的函数。</p></li> <li><p>特点</p> <ul><li>封装,复用</li> <li>可以接受参数，也可以返回数据</li> <li>存储过程无法使用 SELECT 指令来运行，因为它是子程序，与查看表，数据表或用户定义函数不同。</li> <li>存储过程可以用在数据检验，强制实行商业逻辑等。</li> <li>减少网络交互，效率提升</li></ul></li> <li><p>创建</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">procedure</span> 存储过程名称<span class="token punctuation">(</span><span class="token punctuation">[</span>参数列表<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">begin</span>
	<span class="token comment">-- sql语句</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>调用</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">call</span> 名称<span class="token punctuation">(</span><span class="token punctuation">[</span>参数<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>查看</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span>ROUTINES <span class="token keyword">where</span> ROUTINE_SCHEMA<span class="token operator">=</span><span class="token string">'itcast'</span>

<span class="token keyword">show</span> <span class="token keyword">create</span> <span class="token keyword">procedure</span> p1<span class="token punctuation">;</span>
</code></pre></div></li> <li><p>删除</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">drop</span> <span class="token keyword">procedure</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> p1
</code></pre></div></li> <li><p>变量</p> <ul><li>系统变量：系统变量是MySQL系统服务器提供，不是用户定义的，属于服务器层面，分为全局变量和会话变量</li> <li>用户定义变量：用户根据需要自己定义的变量，用户变量不用提前声明，在用的时候直接用“@变量名”使用即可，其作用域为当前连接</li> <li>局部变量：根据需要定义的在局部生效的变量，访问之前，需要DECLARE声明。可用作存储过程内的局部变量和输入参数，局部变量的范围是在其内声明的BEGIN...END块</li></ul></li> <li><p>if判断</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">procedure</span> p3<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">begin</span>
    <span class="token keyword">declare</span> score <span class="token keyword">int</span> <span class="token keyword">default</span> <span class="token number">58</span><span class="token punctuation">;</span>
    <span class="token keyword">declare</span> result <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> score <span class="token operator">&gt;=</span> <span class="token number">85</span> <span class="token keyword">then</span>
        <span class="token keyword">set</span> result :<span class="token operator">=</span> <span class="token string">'优秀'</span><span class="token punctuation">;</span>
    <span class="token keyword">elseif</span> score <span class="token operator">&gt;=</span> <span class="token number">60</span> <span class="token keyword">then</span>
        <span class="token keyword">set</span> result :<span class="token operator">=</span> <span class="token string">'及格'</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token keyword">set</span> result :<span class="token operator">=</span> <span class="token string">'不及格'</span><span class="token punctuation">;</span>
    <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>
    <span class="token keyword">select</span> result<span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>参数</p> <table><thead><tr><th>类型</th> <th>含义</th> <th>备注</th></tr></thead> <tbody><tr><td>IN</td> <td>该类参数作为输入，也就是需要调用时传入值</td> <td>默认</td></tr> <tr><td>OUT</td> <td>该类参数作为输出，也就是该参数可以作为返回值</td> <td></td></tr> <tr><td>INOUT</td> <td>既可以作为输入参数，也可以作为输出参数</td> <td></td></tr></tbody></table> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- 根据传入的200分制的分数，进行换算，换算成百分制，然后返回</span>
<span class="token keyword">create</span> <span class="token keyword">procedure</span> p5<span class="token punctuation">(</span><span class="token keyword">inout</span> score <span class="token keyword">double</span><span class="token punctuation">)</span>
<span class="token keyword">begin</span>
    <span class="token keyword">set</span> score :<span class="token operator">=</span> score <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>

<span class="token keyword">set</span> <span class="token variable">@score</span> <span class="token operator">=</span> <span class="token number">198</span><span class="token punctuation">;</span>
<span class="token keyword">call</span> p5<span class="token punctuation">(</span><span class="token variable">@score</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token variable">@score</span><span class="token punctuation">;</span>

</code></pre></div></li> <li><p>case</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- 根据传入的月份，判定月份所属的季节（要求采用case结构）。</span>
<span class="token comment">-- 1-3月份，为第一季度</span>
<span class="token comment">-- 4-6月份，为第二季度</span>
<span class="token comment">-- 7-9月份，为第三季度</span>
<span class="token comment">-- 10-12月份，为第四季度</span>

<span class="token keyword">create</span> <span class="token keyword">procedure</span> p6<span class="token punctuation">(</span><span class="token operator">in</span> <span class="token keyword">month</span> <span class="token keyword">int</span><span class="token punctuation">)</span>
<span class="token keyword">begin</span>
    <span class="token keyword">declare</span> result <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span>
        <span class="token keyword">when</span> <span class="token keyword">month</span> <span class="token operator">&gt;=</span> <span class="token number">1</span> <span class="token operator">and</span> <span class="token keyword">month</span> <span class="token operator">&lt;=</span> <span class="token number">3</span> <span class="token keyword">then</span>
            <span class="token keyword">set</span> result :<span class="token operator">=</span> <span class="token string">'第一季度'</span><span class="token punctuation">;</span>
        <span class="token keyword">when</span> <span class="token keyword">month</span> <span class="token operator">&gt;=</span> <span class="token number">4</span> <span class="token operator">and</span> <span class="token keyword">month</span> <span class="token operator">&lt;=</span> <span class="token number">6</span> <span class="token keyword">then</span>
            <span class="token keyword">set</span> result :<span class="token operator">=</span> <span class="token string">'第二季度'</span><span class="token punctuation">;</span>
        <span class="token keyword">when</span> <span class="token keyword">month</span> <span class="token operator">&gt;=</span> <span class="token number">7</span> <span class="token operator">and</span> <span class="token keyword">month</span> <span class="token operator">&lt;=</span> <span class="token number">9</span> <span class="token keyword">then</span>
            <span class="token keyword">set</span> result :<span class="token operator">=</span> <span class="token string">'第三季度'</span><span class="token punctuation">;</span>
        <span class="token keyword">when</span> <span class="token keyword">month</span> <span class="token operator">&gt;=</span> <span class="token number">10</span> <span class="token operator">and</span> <span class="token keyword">month</span> <span class="token operator">&lt;=</span> <span class="token number">12</span> <span class="token keyword">then</span>
            <span class="token keyword">set</span> result :<span class="token operator">=</span> <span class="token string">'第四季度'</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">set</span> result :<span class="token operator">=</span> <span class="token string">'非法参数'</span><span class="token punctuation">;</span>
    <span class="token keyword">end</span> <span class="token keyword">case</span> <span class="token punctuation">;</span>

    <span class="token keyword">select</span> concat<span class="token punctuation">(</span><span class="token string">'您输入的月份为: '</span><span class="token punctuation">,</span><span class="token keyword">month</span><span class="token punctuation">,</span> <span class="token string">', 所属的季度为: '</span><span class="token punctuation">,</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>

</code></pre></div></li> <li><p>循环</p> <ul><li><p>while</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- 计算从1累加到n的值，n为传入的参数值</span>
<span class="token keyword">create</span> <span class="token keyword">procedure</span> p7<span class="token punctuation">(</span><span class="token operator">in</span> n <span class="token keyword">int</span><span class="token punctuation">)</span>
<span class="token keyword">begin</span>
    <span class="token keyword">declare</span> total <span class="token keyword">int</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> n<span class="token operator">&gt;</span><span class="token number">0</span> <span class="token keyword">do</span>
         <span class="token keyword">set</span> total :<span class="token operator">=</span> total <span class="token operator">+</span> n<span class="token punctuation">;</span>
         <span class="token keyword">set</span> n :<span class="token operator">=</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">end</span> <span class="token keyword">while</span><span class="token punctuation">;</span>

    <span class="token keyword">select</span> total<span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>

</code></pre></div></li> <li><p>repeat</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">procedure</span> p8<span class="token punctuation">(</span><span class="token operator">in</span> n <span class="token keyword">int</span><span class="token punctuation">)</span>
<span class="token keyword">begin</span>
    <span class="token keyword">declare</span> total <span class="token keyword">int</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">repeat</span>
        <span class="token keyword">set</span> total :<span class="token operator">=</span> total <span class="token operator">+</span> n<span class="token punctuation">;</span>
        <span class="token keyword">set</span> n :<span class="token operator">=</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    until  n <span class="token operator">&lt;=</span> <span class="token number">0</span>
    <span class="token keyword">end</span> <span class="token keyword">repeat</span><span class="token punctuation">;</span>

    <span class="token keyword">select</span> total<span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>

</code></pre></div></li> <li><p>loop：可以配合LEAVE和ITERATE语句进行使用</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">procedure</span> p9<span class="token punctuation">(</span><span class="token operator">in</span> n <span class="token keyword">int</span><span class="token punctuation">)</span>
<span class="token keyword">begin</span>
    <span class="token keyword">declare</span> total <span class="token keyword">int</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">;</span>

    sum:<span class="token keyword">loop</span>
        <span class="token keyword">if</span> n<span class="token operator">&lt;=</span><span class="token number">0</span> <span class="token keyword">then</span>
            <span class="token keyword">leave</span> sum<span class="token punctuation">;</span>
        <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>

        <span class="token keyword">set</span> total :<span class="token operator">=</span> total <span class="token operator">+</span> n<span class="token punctuation">;</span>
        <span class="token keyword">set</span> n :<span class="token operator">=</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">end</span> <span class="token keyword">loop</span> sum<span class="token punctuation">;</span>

    <span class="token keyword">select</span> total<span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>

</code></pre></div></li> <li><p>游标cursor：用来存储查询结果集的数据类型，在存储过程和函数中可以使用游标对结果集进行循环的处理。游标的使用包括游标的声明、OPEN、FETCH和CLOSE</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- 根据传入的参数uage，来查询用户表 tb_user中，所有的用户年龄小于等于uage的用户姓名（name）和专业（profession），</span>
<span class="token comment">-- 并将用户的姓名和专业插入到所创建的一张新表(id,name,profession)中。</span>

<span class="token comment">-- 逻辑:</span>
<span class="token comment">-- A. 声明游标, 存储查询结果集</span>
<span class="token comment">-- B. 准备: 创建表结构</span>
<span class="token comment">-- C. 开启游标</span>
<span class="token comment">-- D. 获取游标中的记录</span>
<span class="token comment">-- E. 插入数据到新表中</span>
<span class="token comment">-- F. 关闭游标</span>
<span class="token keyword">create</span> <span class="token keyword">procedure</span> p11<span class="token punctuation">(</span><span class="token operator">in</span> uage <span class="token keyword">int</span><span class="token punctuation">)</span>
<span class="token keyword">begin</span>
    <span class="token keyword">declare</span> uname <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">declare</span> upro <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">declare</span> u_cursor <span class="token keyword">cursor</span> <span class="token keyword">for</span> <span class="token keyword">select</span> name<span class="token punctuation">,</span>profession <span class="token keyword">from</span> tb_user <span class="token keyword">where</span> age <span class="token operator">&lt;=</span> uage<span class="token punctuation">;</span>
    <span class="token keyword">declare</span> <span class="token keyword">exit</span> <span class="token keyword">handler</span> <span class="token keyword">for</span> SQLSTATE <span class="token string">'02000'</span> <span class="token keyword">close</span> u_cursor<span class="token punctuation">;</span>

    <span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> tb_user_pro<span class="token punctuation">;</span>
    <span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> tb_user_pro<span class="token punctuation">(</span>
        id <span class="token keyword">int</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
        name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        profession <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">open</span> u_cursor<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token boolean">true</span> <span class="token keyword">do</span>
        <span class="token keyword">fetch</span> u_cursor <span class="token keyword">into</span> uname<span class="token punctuation">,</span>upro<span class="token punctuation">;</span>
        <span class="token keyword">insert</span> <span class="token keyword">into</span> tb_user_pro <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span> uname<span class="token punctuation">,</span> upro<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">end</span> <span class="token keyword">while</span><span class="token punctuation">;</span>
    <span class="token keyword">close</span> u_cursor<span class="token punctuation">;</span>

<span class="token keyword">end</span><span class="token punctuation">;</span>

</code></pre></div></li> <li><p>条件处理程序handler：可以用来定义在流程控制结构执行过程中遇到问题时相应的处理步骤。以上的循环中由于没有定义退出循环的条件，于是在游标遍历完所有的数据后就会报错，因此就需要用到条件处理程序</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">procedure</span> p12<span class="token punctuation">(</span><span class="token operator">in</span> uage <span class="token keyword">int</span><span class="token punctuation">)</span>
<span class="token keyword">begin</span>
    <span class="token keyword">declare</span> uname <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">declare</span> upro <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">declare</span> u_cursor <span class="token keyword">cursor</span> <span class="token keyword">for</span> <span class="token keyword">select</span> name<span class="token punctuation">,</span>profession <span class="token keyword">from</span> tb_user <span class="token keyword">where</span> age <span class="token operator">&lt;=</span> uage<span class="token punctuation">;</span>
    <span class="token keyword">declare</span> <span class="token keyword">exit</span> <span class="token keyword">handler</span> <span class="token keyword">for</span> <span class="token operator">not</span> found <span class="token keyword">close</span> u_cursor<span class="token punctuation">;</span>

    <span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> tb_user_pro<span class="token punctuation">;</span>
    <span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> tb_user_pro<span class="token punctuation">(</span>
        id <span class="token keyword">int</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
        name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        profession <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">open</span> u_cursor<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token boolean">true</span> <span class="token keyword">do</span>
        <span class="token keyword">fetch</span> u_cursor <span class="token keyword">into</span> uname<span class="token punctuation">,</span>upro<span class="token punctuation">;</span>
        <span class="token keyword">insert</span> <span class="token keyword">into</span> tb_user_pro <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span> uname<span class="token punctuation">,</span> upro<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">end</span> <span class="token keyword">while</span><span class="token punctuation">;</span>
    <span class="token keyword">close</span> u_cursor<span class="token punctuation">;</span>

<span class="token keyword">end</span><span class="token punctuation">;</span>

</code></pre></div></li></ul></li></ul> <h3 id="存储函数"><a href="#存储函数" class="header-anchor">#</a> <strong>存储函数</strong></h3> <aside>
⚠️ 存储函数是有返回值的存储过程，存储函数的参数只能是IN类型的
</aside> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- 从1到n的累加</span>

<span class="token keyword">create</span> <span class="token keyword">function</span> fun1<span class="token punctuation">(</span>n <span class="token keyword">int</span><span class="token punctuation">)</span>
<span class="token keyword">returns</span> <span class="token keyword">int</span> <span class="token keyword">deterministic</span>
<span class="token keyword">begin</span>
    <span class="token keyword">declare</span> total <span class="token keyword">int</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> n<span class="token operator">&gt;</span><span class="token number">0</span> <span class="token keyword">do</span>
        <span class="token keyword">set</span> total :<span class="token operator">=</span> total <span class="token operator">+</span> n<span class="token punctuation">;</span>
        <span class="token keyword">set</span> n :<span class="token operator">=</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">end</span> <span class="token keyword">while</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> total<span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> fun1<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>return type 说明
<ul><li>deterministic：相同的输入参数总是产生相同的结果</li> <li>no sql：不包含sql语句</li> <li>reads sql data：包含读取数据的语句，但不包含写入数据的语句</li></ul></li></ul> <h3 id="触发器"><a href="#触发器" class="header-anchor">#</a> <strong>触发器</strong></h3> <aside>
👽 介绍：触发器是与表有关的数据库对象，指在insert/update/delete之前或之后，触发并执行触发器中定义的sql语句集合。触发器这种特性可以协助应用在数据库端确保数据的完整性，日志记录，数据校验等操作
</aside> <ul><li><p>insert语法</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- 需求: 通过触发器记录 user 表的数据变更日志(user_logs) , 包含增加, 修改 , 删除 ;</span>

<span class="token comment">-- 准备工作 : 日志表 user_logs</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> user_logs<span class="token punctuation">(</span>
  id <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
  operation <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'操作类型, insert/update/delete'</span><span class="token punctuation">,</span>
  operate_time <span class="token keyword">datetime</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'操作时间'</span><span class="token punctuation">,</span>
  operate_id <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'操作的ID'</span><span class="token punctuation">,</span>
  operate_params <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">'操作参数'</span><span class="token punctuation">,</span>
  <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">innodb</span> <span class="token keyword">default</span> <span class="token keyword">charset</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

<span class="token comment">-- 插入数据触发器</span>
<span class="token keyword">create</span> <span class="token keyword">trigger</span> tb_user_insert_trigger
    <span class="token keyword">after</span> <span class="token keyword">insert</span> <span class="token keyword">on</span> tb_user <span class="token keyword">for each row</span>
<span class="token keyword">begin</span>
    <span class="token keyword">insert</span> <span class="token keyword">into</span> user_logs<span class="token punctuation">(</span>id<span class="token punctuation">,</span> operation<span class="token punctuation">,</span> operate_time<span class="token punctuation">,</span> operate_id<span class="token punctuation">,</span> operate_params<span class="token punctuation">)</span> <span class="token keyword">VALUES</span>
    <span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token string">'insert'</span><span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> new<span class="token punctuation">.</span>id<span class="token punctuation">,</span> concat<span class="token punctuation">(</span><span class="token string">'插入的数据内容为: id='</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>id<span class="token punctuation">,</span><span class="token string">',name='</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">', phone='</span><span class="token punctuation">,</span> NEW<span class="token punctuation">.</span>phone<span class="token punctuation">,</span> <span class="token string">', email='</span><span class="token punctuation">,</span> NEW<span class="token punctuation">.</span>email<span class="token punctuation">,</span> <span class="token string">', profession='</span><span class="token punctuation">,</span> NEW<span class="token punctuation">.</span>profession<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>

<span class="token comment">-- 查看</span>
<span class="token keyword">show</span> triggers <span class="token punctuation">;</span>

<span class="token comment">-- 删除</span>
<span class="token keyword">drop</span> <span class="token keyword">trigger</span> tb_user_insert_trigger<span class="token punctuation">;</span>

<span class="token comment">-- 插入数据到tb_user</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> tb_user<span class="token punctuation">(</span>id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> phone<span class="token punctuation">,</span> email<span class="token punctuation">,</span> profession<span class="token punctuation">,</span> age<span class="token punctuation">,</span> gender<span class="token punctuation">,</span> <span class="token keyword">status</span><span class="token punctuation">,</span> createtime<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">26</span><span class="token punctuation">,</span><span class="token string">'三皇子'</span><span class="token punctuation">,</span><span class="token string">'18809091212'</span><span class="token punctuation">,</span><span class="token string">'erhuangzi@163.com'</span><span class="token punctuation">,</span><span class="token string">'软件工程'</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div></li> <li><p>update语法</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- 修改数据触发器</span>
<span class="token keyword">create</span> <span class="token keyword">trigger</span> tb_user_update_trigger
    <span class="token keyword">after</span> <span class="token keyword">update</span> <span class="token keyword">on</span> tb_user <span class="token keyword">for each row</span>
<span class="token keyword">begin</span>
    <span class="token keyword">insert</span> <span class="token keyword">into</span> user_logs<span class="token punctuation">(</span>id<span class="token punctuation">,</span> operation<span class="token punctuation">,</span> operate_time<span class="token punctuation">,</span> operate_id<span class="token punctuation">,</span> operate_params<span class="token punctuation">)</span> <span class="token keyword">VALUES</span>
    <span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token string">'update'</span><span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> new<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
        concat<span class="token punctuation">(</span><span class="token string">'更新之前的数据: id='</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>id<span class="token punctuation">,</span><span class="token string">',name='</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">', phone='</span><span class="token punctuation">,</span> old<span class="token punctuation">.</span>phone<span class="token punctuation">,</span> <span class="token string">', email='</span><span class="token punctuation">,</span> old<span class="token punctuation">.</span>email<span class="token punctuation">,</span> <span class="token string">', profession='</span><span class="token punctuation">,</span> old<span class="token punctuation">.</span>profession<span class="token punctuation">,</span>
            <span class="token string">' | 更新之后的数据: id='</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>id<span class="token punctuation">,</span><span class="token string">',name='</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">', phone='</span><span class="token punctuation">,</span> NEW<span class="token punctuation">.</span>phone<span class="token punctuation">,</span> <span class="token string">', email='</span><span class="token punctuation">,</span> NEW<span class="token punctuation">.</span>email<span class="token punctuation">,</span> <span class="token string">', profession='</span><span class="token punctuation">,</span> NEW<span class="token punctuation">.</span>profession<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>

<span class="token keyword">show</span> triggers <span class="token punctuation">;</span>

<span class="token keyword">update</span> tb_user <span class="token keyword">set</span> profession <span class="token operator">=</span> <span class="token string">'会计'</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">23</span><span class="token punctuation">;</span>

<span class="token keyword">update</span> tb_user <span class="token keyword">set</span> profession <span class="token operator">=</span> <span class="token string">'会计'</span> <span class="token keyword">where</span> id <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span>

</code></pre></div></li> <li><p>delete语法</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- 删除数据触发器</span>
<span class="token keyword">create</span> <span class="token keyword">trigger</span> tb_user_delete_trigger
    <span class="token keyword">after</span> <span class="token keyword">delete</span> <span class="token keyword">on</span> tb_user <span class="token keyword">for each row</span>
<span class="token keyword">begin</span>
    <span class="token keyword">insert</span> <span class="token keyword">into</span> user_logs<span class="token punctuation">(</span>id<span class="token punctuation">,</span> operation<span class="token punctuation">,</span> operate_time<span class="token punctuation">,</span> operate_id<span class="token punctuation">,</span> operate_params<span class="token punctuation">)</span> <span class="token keyword">VALUES</span>
    <span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token string">'delete'</span><span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> old<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
        concat<span class="token punctuation">(</span><span class="token string">'删除之前的数据: id='</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>id<span class="token punctuation">,</span><span class="token string">',name='</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">', phone='</span><span class="token punctuation">,</span> old<span class="token punctuation">.</span>phone<span class="token punctuation">,</span> <span class="token string">', email='</span><span class="token punctuation">,</span> old<span class="token punctuation">.</span>email<span class="token punctuation">,</span> <span class="token string">', profession='</span><span class="token punctuation">,</span> old<span class="token punctuation">.</span>profession<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>

<span class="token keyword">show</span> triggers <span class="token punctuation">;</span>

<span class="token keyword">delete</span> <span class="token keyword">from</span> tb_user <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">26</span><span class="token punctuation">;</span>

</code></pre></div></li></ul> <h2 id="锁"><a href="#锁" class="header-anchor">#</a> 锁</h2> <aside>
💡 锁
<p>锁是计算机协调多个进程或线程并发访问某一资源的机制。在数据库中，除了传统的计算资源的争用外，数据也是一种供许多用户共享的资源。如何保证数据并发访问的一致性、有效性是所有数据库必须解决的一个问题，锁冲突也是影响数据库并发访问性能的一个重要因素。按照锁的粒度分，分为以下三类</p> <p>· 全局锁：锁定数据库中的所有表</p> <p>· 表级锁：每次操作锁住整张表</p> <p>· 行级锁：每次操作锁住对应的行数据</p></aside> <h3 id="全局锁"><a href="#全局锁" class="header-anchor">#</a> 全局锁</h3> <aside>
💡 全局锁是对整个数据库实例加锁，加锁后整个实例就处于只读状态，后续的DML的写语句，DDL语句，以及更新操作的事务提交语句都将被阻塞
</aside> <div class="language-sql extra-class"><pre class="language-sql"><code>flush <span class="token keyword">tables</span> <span class="token keyword">with</span> <span class="token keyword">read</span> <span class="token keyword">lock</span><span class="token punctuation">;</span>  <span class="token comment">-- 施加全局锁</span>
mysqldump uroot <span class="token operator">-</span>p1234 itcast<span class="token operator">&gt;</span>itcast<span class="token punctuation">.</span><span class="token keyword">sql</span>  <span class="token comment">-- 数据备份</span>
<span class="token keyword">unlock</span> <span class="token keyword">tables</span><span class="token punctuation">;</span>  <span class="token comment">-- 解锁</span>

</code></pre></div><ul><li>特点：数据库中加全局锁，是一个比较重的操作，存在以下问题
<ul><li>如果在主库上备份，那么在备份期间都不能执行更新，业务基本上就得停摆</li> <li>如果在从库上备份，那么在备份期间从库不能执行主库同步过来的二进制日志，会导致主从延迟</li></ul></li></ul> <h3 id="表级锁"><a href="#表级锁" class="header-anchor">#</a> <strong>表级锁</strong></h3> <ul><li>表级锁，每次操作锁住整张表。锁定粒度大，发生锁冲突的概率最高，并发度最低</li> <li>表锁
<ul><li>表共享读锁（read lock）：只能读不能写，且不会阻塞其他客户端的读操作，但会阻塞其他客户端的写操作</li> <li>表独占写锁（write lock）：对于当前客户端，既能读也能写，对于其他客户端，既不能读也不能写。</li> <li>语法
◦ 加锁：lock tables 表名 read/write
◦ 释放锁：unlock tables</li></ul></li> <li>元数据锁（meta data lock，MDL）：MDL加锁过程是系统自动控制，无需显式使用，在访问一张表的时候会自动加上。MDL锁主要作用就是维护表元数据的数据一致性，在表上有活动事务的时候，不可以对元数据进行写入操作。以下标为为MDL类型及其对应SQL语句</li></ul> <table><thead><tr><th>对应SQL</th> <th>锁类型</th> <th>说明</th></tr></thead> <tbody><tr><td>lock tables xxx read/write</td> <td>SHARED_READ_ONLY/SHARED_NO_READ_WRITE</td> <td></td></tr> <tr><td>select、select ... lock in share mode</td> <td>SHARED_READ</td> <td>与SHARED_READ、SHARED_READ兼容，与EXLUSIVE互斥</td></tr> <tr><td>insert、update、delete、select ... for update</td> <td>SHARED_READ</td> <td>与SHARED_READ、SHARED_READ兼容，与EXLUSIVE互斥</td></tr> <tr><td>alter table</td> <td>EXLUSIVE</td> <td>与其他的MDL互斥</td></tr></tbody></table> <p>同样可以查看元数据锁</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> object_type<span class="token punctuation">,</span>object_schema<span class="token punctuation">,</span>object_name<span class="token punctuation">,</span>lock_type<span class="token punctuation">,</span>lock_duration <span class="token keyword">from</span> performance_schema<span class="token punctuation">.</span>metadata_locks<span class="token punctuation">;</span>
</code></pre></div><ul><li>意向锁：为了避免DML在执行时，加的行锁与表锁的冲突，在InnoDB中引入了意向锁，使得表锁不用检查每行数据是否加锁，使用意向锁来减少表锁的检查。
<ul><li>意向共享锁：由语句select ... lock in share mode添加。与表锁共享锁兼容，与表锁排他锁互斥</li> <li>意向排他锁：由insert、update、delete、select ... for update添加。与表锁共享锁及排他锁互斥，意向锁之间不会互斥</li></ul></li></ul> <h3 id="行级锁"><a href="#行级锁" class="header-anchor">#</a> <strong>行级锁</strong></h3> <blockquote><p>行级锁：每次操作锁住对应的行数据。锁定粒度最小，发生锁冲突的概率最低，并发度最高。InnoDB的数据是基于索引组织的，行锁是通过对索引上的索引项加锁来实现的，对于行级锁，主要分为以下三类</p></blockquote> <ul><li><p>行锁：锁定单个行记录的锁，防止其他事务对此行进行update和delete操作</p> <ul><li><p>共享锁：允许一个事务去读一行，组织其他事务获得相同数据集的排他锁</p></li> <li><p>排他锁：允许获取排他锁的事务更新数据，组织其他事务获得相同数据集的共享锁和排他锁</p> <table><thead><tr><th>SQL</th> <th>行锁类型</th> <th>说明</th></tr></thead> <tbody><tr><td>insert</td> <td>排他锁</td> <td>自动加锁</td></tr> <tr><td>update</td> <td>排他锁</td> <td>自动加锁</td></tr> <tr><td>delete</td> <td>排他锁</td> <td>自动加锁</td></tr> <tr><td>select</td> <td>不加任何锁</td> <td></td></tr> <tr><td>select ... lock in share mode</td> <td>共享锁</td> <td>需要手动在select后面加lock in share mode</td></tr> <tr><td>select ... for update</td> <td>排他锁</td> <td>需要手动在select后面加for update</td></tr></tbody></table></li></ul></li> <li><p>间隙锁：锁定索引记录间隙，确保索引记录间隙不变，防止其他事务在这个间隙进行insert，产生幻读。间隙锁唯一目的是防止其他事务插入间隙。间隙锁可以共存，一个事务采用的间隙锁不会阻止另一个事务在同一间隙上采用间隙锁</p></li> <li><p>临键锁：行锁和间隙锁结合，同时锁住数据，并锁住数据前面的间隙Gap</p></li></ul></div></section> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/notes/notes/sql/basic.html" class="prev">
          基础理念
        </a></span> <span class="next"><a href="/notes/notes/review.html">
          面试集合点
        </a></span></p></div> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/notes/notes/sql/develop.html#mysql体系结构" class="sidebar-link reco-side-mysql体系结构" data-v-b57cc07c>MySQL体系结构</a></li><li class="level-2" data-v-b57cc07c><a href="/notes/notes/sql/develop.html#存储引擎" class="sidebar-link reco-side-存储引擎" data-v-b57cc07c>存储引擎</a></li><li class="level-3" data-v-b57cc07c><a href="/notes/notes/sql/develop.html#简介" class="sidebar-link reco-side-简介" data-v-b57cc07c>简介</a></li><li class="level-3" data-v-b57cc07c><a href="/notes/notes/sql/develop.html#特点" class="sidebar-link reco-side-特点" data-v-b57cc07c>特点</a></li><li class="level-2" data-v-b57cc07c><a href="/notes/notes/sql/develop.html#索引" class="sidebar-link reco-side-索引" data-v-b57cc07c>索引</a></li><li class="level-3" data-v-b57cc07c><a href="/notes/notes/sql/develop.html#概述" class="sidebar-link reco-side-概述" data-v-b57cc07c>概述</a></li><li class="level-3" data-v-b57cc07c><a href="/notes/notes/sql/develop.html#结构" class="sidebar-link reco-side-结构" data-v-b57cc07c>结构</a></li><li class="level-3" data-v-b57cc07c><a href="/notes/notes/sql/develop.html#索引分类" class="sidebar-link reco-side-索引分类" data-v-b57cc07c>索引分类</a></li><li class="level-3" data-v-b57cc07c><a href="/notes/notes/sql/develop.html#索引语法" class="sidebar-link reco-side-索引语法" data-v-b57cc07c>索引语法</a></li><li class="level-3" data-v-b57cc07c><a href="/notes/notes/sql/develop.html#sql性能分析" class="sidebar-link reco-side-sql性能分析" data-v-b57cc07c>SQL性能分析</a></li><li class="level-3" data-v-b57cc07c><a href="/notes/notes/sql/develop.html#索引使用规则" class="sidebar-link reco-side-索引使用规则" data-v-b57cc07c>索引使用规则</a></li><li class="level-3" data-v-b57cc07c><a href="/notes/notes/sql/develop.html#索引设计原则" class="sidebar-link reco-side-索引设计原则" data-v-b57cc07c>索引设计原则</a></li><li class="level-2" data-v-b57cc07c><a href="/notes/notes/sql/develop.html#sql优化" class="sidebar-link reco-side-sql优化" data-v-b57cc07c>SQL优化</a></li><li class="level-3" data-v-b57cc07c><a href="/notes/notes/sql/develop.html#插入数据优化" class="sidebar-link reco-side-插入数据优化" data-v-b57cc07c>插入数据优化</a></li><li class="level-3" data-v-b57cc07c><a href="/notes/notes/sql/develop.html#主键优化" class="sidebar-link reco-side-主键优化" data-v-b57cc07c>主键优化</a></li><li class="level-3" data-v-b57cc07c><a href="/notes/notes/sql/develop.html#order-by优化" class="sidebar-link reco-side-order-by优化" data-v-b57cc07c>order by优化</a></li><li class="level-3" data-v-b57cc07c><a href="/notes/notes/sql/develop.html#group-by优化" class="sidebar-link reco-side-group-by优化" data-v-b57cc07c>group by优化</a></li><li class="level-3" data-v-b57cc07c><a href="/notes/notes/sql/develop.html#limit优化" class="sidebar-link reco-side-limit优化" data-v-b57cc07c>limit优化</a></li><li class="level-2" data-v-b57cc07c><a href="/notes/notes/sql/develop.html#视图-存储过程-触发器" class="sidebar-link reco-side-视图-存储过程-触发器" data-v-b57cc07c>视图-存储过程-触发器</a></li><li class="level-3" data-v-b57cc07c><a href="/notes/notes/sql/develop.html#视图" class="sidebar-link reco-side-视图" data-v-b57cc07c>视图</a></li><li class="level-3" data-v-b57cc07c><a href="/notes/notes/sql/develop.html#存储过程" class="sidebar-link reco-side-存储过程" data-v-b57cc07c>存储过程</a></li><li class="level-3" data-v-b57cc07c><a href="/notes/notes/sql/develop.html#存储函数" class="sidebar-link reco-side-存储函数" data-v-b57cc07c>存储函数</a></li><li class="level-3" data-v-b57cc07c><a href="/notes/notes/sql/develop.html#触发器" class="sidebar-link reco-side-触发器" data-v-b57cc07c>触发器</a></li><li class="level-2" data-v-b57cc07c><a href="/notes/notes/sql/develop.html#锁" class="sidebar-link reco-side-锁" data-v-b57cc07c>锁</a></li><li class="level-3" data-v-b57cc07c><a href="/notes/notes/sql/develop.html#全局锁" class="sidebar-link reco-side-全局锁" data-v-b57cc07c>全局锁</a></li><li class="level-3" data-v-b57cc07c><a href="/notes/notes/sql/develop.html#表级锁" class="sidebar-link reco-side-表级锁" data-v-b57cc07c>表级锁</a></li><li class="level-3" data-v-b57cc07c><a href="/notes/notes/sql/develop.html#行级锁" class="sidebar-link reco-side-行级锁" data-v-b57cc07c>行级锁</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/notes/assets/js/app.74070628.js" defer></script><script src="/notes/assets/js/7.8c1b57da.js" defer></script><script src="/notes/assets/js/2.08219823.js" defer></script><script src="/notes/assets/js/1.03a74d01.js" defer></script><script src="/notes/assets/js/45.648d69eb.js" defer></script>
  </body>
</html>
